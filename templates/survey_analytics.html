{% extends "base.html" %}

{% block title %}Detailed Survey Analytics - Surveyor Data Viewer{% endblock %}

{% block header %}
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-chart-bar text-survey-blue mr-3"></i>
                Detailed Survey Analytics
            </h1>
            <p class="text-gray-600">In-depth analysis of survey questions, submissions, and statistical insights</p>
        </div>
        <div class="flex space-x-3">
            <select id="surveyFilter" onchange="filterBySurvey(this.value)"
                    class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-survey-blue">
                <option value="">All Surveys</option>
                {% set seen_surveys = [] %}
                {% for survey in question_analytics %}
                    {% if survey.survey_name not in seen_surveys %}
                        {% set _ = seen_surveys.append(survey.survey_name) %}
                        <option value="{{ loop.index }}" {% if selected_survey_id == loop.index %}selected{% endif %}>
                            {{ survey.survey_name }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
            <a href="{{ url_for('survey_dashboard') }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Analytics Overview -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <!-- Total Questions -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-question-circle text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Total Questions</p>
                <p class="text-2xl font-bold text-gray-900">{{ question_analytics|length }}</p>
            </div>
        </div>
    </div>

    <!-- Average Response Rate -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-percentage text-green-600 text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Avg Response Rate</p>
                <p class="text-2xl font-bold text-gray-900">
                    {% if question_analytics %}
                        {{ "%.1f"|format((question_analytics|map(attribute='response_rate')|sum) / (question_analytics|length)) }}%
                    {% else %}
                        0%
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Most Answered -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-star text-purple-600 text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Most Answered</p>
                <p class="text-lg font-bold text-gray-900">
                    {% if question_analytics %}
                        {{ question_analytics[0].answered_count }}
                    {% else %}
                        0
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Unique Submissions -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-orange-600 text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Unique Submissions</p>
                <p class="text-2xl font-bold text-gray-900">
                    {% if question_analytics %}
                        {{ (question_analytics|map(attribute='unique_answers')|sum) }}
                    {% else %}
                        0
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Question Analysis Table -->
<div class="bg-white rounded-lg shadow-md mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-table text-survey-blue mr-2"></i>
                Question Analysis
            </h3>
            <div class="flex space-x-2">
                <button onclick="exportData()" 
                        class="text-sm text-survey-blue hover:text-blue-700 font-medium">
                    <i class="fas fa-download mr-1"></i>Export CSV
                </button>
                <button onclick="refreshData()" 
                        class="text-sm text-survey-blue hover:text-blue-700 font-medium">
                    <i class="fas fa-refresh mr-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
    <div class="overflow-x-auto">
        {% if question_analytics %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Question
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Survey
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Response Rate
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Answered
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Unique Answers
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for question in question_analytics %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">
                            {{ question.question_key }}
                        </div>
                        {% if question.question_text and question.question_text != question.question_key %}
                        <div class="text-sm text-gray-500">
                            {{ question.question_text[:100] }}{% if question.question_text|length > 100 %}...{% endif %}
                        </div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">{{ question.survey_name }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900">{{ question.response_rate or 0 }}%</div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="h-2 rounded-full 
                                        {% if question.response_rate >= 80 %}bg-green-500
                                        {% elif question.response_rate >= 60 %}bg-yellow-500
                                        {% elif question.response_rate >= 40 %}bg-orange-500
                                        {% else %}bg-red-500{% endif %}" 
                                         style="width: {{ question.response_rate or 0 }}%"></div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">{{ question.answered_count or 0 }}</div>
                        <div class="text-sm text-gray-500">of {{ question.total_answers or 0 }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">{{ question.unique_answers or 0 }}</div>
                        {% if question.avg_numeric_value %}
                        <div class="text-sm text-gray-500">Avg: {{ "%.2f"|format(question.avg_numeric_value) }}</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <button onclick="viewAnswers({{ question.id }})" 
                                class="text-survey-blue hover:text-blue-700 mr-3">
                            View Answers
                        </button>
                        <button onclick="analyzeQuestion({{ question.id }})" 
                                class="text-survey-green hover:text-green-700">
                            Analyze
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-chart-bar text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No analytics data available</h3>
            <p class="text-gray-500">Run the survey normalizer to generate analytics data</p>
            <button onclick="runNormalizer()" 
                    class="mt-4 inline-flex items-center px-4 py-2 bg-survey-blue text-white rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-play mr-2"></i>
                Run Normalizer
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Time Series Charts -->
{% if time_series and time_series.daily_responses %}
<div class="bg-white rounded-lg shadow-md mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-chart-line text-survey-green mr-2"></i>
            Submission Trends (Last 30 Days)
        </h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Daily Submissions Chart -->
            <div>
                <h4 class="font-medium text-gray-900 mb-4">Daily Submission Volume</h4>
                <div class="space-y-2">
                    {% for day in time_series.daily_responses[-14:] %}
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">{{ day.date }}</span>
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-medium text-gray-900">{{ day.responses }}</span>
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-survey-green h-2 rounded-full" 
                                     style="width: {{ (day.responses / (time_series.daily_responses|map(attribute='responses')|max)) * 100 }}%"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Survey Type Breakdown -->
            <div>
                <h4 class="font-medium text-gray-900 mb-4">Survey Type Distribution</h4>
                {% if time_series.type_breakdown %}
                <div class="space-y-3">
                    {% set type_totals = {} %}
                    {% for item in time_series.type_breakdown %}
                        {% set _ = type_totals.update({item.survey_type: type_totals.get(item.survey_type, 0) + item.responses}) %}
                    {% endfor %}
                    
                    {% for survey_type, total in type_totals.items() %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-3
                                {% if survey_type == 'survey' %}bg-survey-blue
                                {% elif survey_type == 'assessment' %}bg-survey-green
                                {% elif survey_type == 'inventory' %}bg-survey-purple
                                {% else %}bg-gray-400{% endif %}"></div>
                            <span class="text-sm font-medium text-gray-700">{{ survey_type|title }}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-bold text-gray-900">{{ total }}</span>
                            <span class="text-xs text-gray-500 ml-1">submissions</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-gray-500">No type breakdown data available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Activity -->
{% if activity %}
<div class="bg-white rounded-lg shadow-md">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-clock text-survey-orange mr-2"></i>
            Recent Survey Activity
        </h3>
    </div>
    <div class="p-6">
        <div class="space-y-4">
            {% for item in activity[:10] %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-white text-xs font-medium mr-3
                        {% if item.survey_type == 'survey' %}bg-survey-blue
                        {% elif item.survey_type == 'assessment' %}bg-survey-green
                        {% elif item.survey_type == 'inventory' %}bg-survey-purple
                        {% else %}bg-gray-400{% endif %}">
                        {% if item.survey_type == 'survey' %}S
                        {% elif item.survey_type == 'assessment' %}A
                        {% elif item.survey_type == 'inventory' %}I
                        {% else %}?{% endif %}
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-900">{{ item.survey_name }}</h4>
                        <p class="text-xs text-gray-500">{{ item.response_date }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold text-gray-900">{{ item.response_count }}</div>
                    <div class="text-xs text-gray-500">submissions</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function filterBySurvey(surveyId) {
        const url = new URL(window.location);
        if (surveyId) {
            url.searchParams.set('survey_id', surveyId);
        } else {
            url.searchParams.delete('survey_id');
        }
        window.location.href = url.toString();
    }
    
    function viewAnswers(questionId) {
        // This would open a modal or navigate to detailed answer view
        showNotification(`Viewing answers for question ${questionId}`, 'info');
        // TODO: Implement answer detail view
    }
    
    function analyzeQuestion(questionId) {
        // This would show detailed analytics for the question
        showNotification(`Analyzing question ${questionId}`, 'info');
        // TODO: Implement question analysis modal
    }
    
    function exportData() {
        showNotification('Exporting analytics data...', 'info');
        // TODO: Implement CSV export
    }
    
    function refreshData() {
        showNotification('Refreshing analytics data...', 'info');
        location.reload();
    }
    
    function runNormalizer() {
        showNotification('Starting survey normalizer...', 'info');
        // TODO: Implement normalizer trigger
    }
    
    // Auto-refresh every 5 minutes
    setInterval(function() {
        console.log('Auto-refreshing analytics...');
        location.reload();
    }, 300000);
</script>
{% endblock %}
