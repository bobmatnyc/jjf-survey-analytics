{% extends "base.html" %}

{% block title %}Dashboard - Surveyor Data Viewer{% endblock %}

{% block header %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">
        <i class="fas fa-tachometer-alt text-survey-blue mr-3"></i>
        Dashboard
    </h1>
    <p class="text-gray-600">Overview of your Google Sheets survey data and extraction jobs</p>
</div>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Spreadsheets -->
    <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-survey-blue bg-opacity-10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-table text-survey-blue text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Total Spreadsheets</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.total_spreadsheets }}</p>
            </div>
        </div>
    </div>

    <!-- Total Rows -->
    <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-survey-green bg-opacity-10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-list text-survey-green text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Total Data Rows</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.total_rows }}</p>
            </div>
        </div>
    </div>

    <!-- Extraction Jobs -->
    <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-survey-purple bg-opacity-10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-cogs text-survey-purple text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Extraction Jobs</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.total_jobs }}</p>
            </div>
        </div>
    </div>

    <!-- Latest Job Status -->
    <div class="bg-white rounded-lg shadow-md p-6 hover-scale">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 {% if stats.latest_job and stats.latest_job.status == 'completed' %}bg-green-100{% elif stats.latest_job and stats.latest_job.status == 'failed' %}bg-red-100{% else %}bg-yellow-100{% endif %} rounded-lg flex items-center justify-center">
                    <i class="fas fa-{% if stats.latest_job and stats.latest_job.status == 'completed' %}check-circle text-green-600{% elif stats.latest_job and stats.latest_job.status == 'failed' %}exclamation-triangle text-red-600{% else %}clock text-yellow-600{% endif %} text-xl"></i>
                </div>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Latest Job</p>
                <p class="text-lg font-bold {% if stats.latest_job and stats.latest_job.status == 'completed' %}text-green-600{% elif stats.latest_job and stats.latest_job.status == 'failed' %}text-red-600{% else %}text-yellow-600{% endif %}">
                    {% if stats.latest_job %}
                        {{ stats.latest_job.status|title }}
                    {% else %}
                        No Jobs
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Sheet Types Distribution -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Sheet Types Chart -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-pie text-survey-blue mr-2"></i>
            Sheet Types Distribution
        </h3>
        <div class="space-y-4">
            {% for sheet_type in stats.sheet_types %}
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full mr-3 
                        {% if sheet_type.sheet_type == 'survey' %}bg-survey-blue
                        {% elif sheet_type.sheet_type == 'assessment' %}bg-survey-green
                        {% elif sheet_type.sheet_type == 'inventory' %}bg-survey-purple
                        {% else %}bg-gray-400{% endif %}"></div>
                    <span class="text-sm font-medium text-gray-700 capitalize">{{ sheet_type.sheet_type or 'Unknown' }}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">{{ sheet_type.count }} sheets</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                        {% if sheet_type.with_data > 0 %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ sheet_type.with_data }} with data
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Latest Job Details -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-info-circle text-survey-blue mr-2"></i>
            Latest Extraction Job
        </h3>
        {% if stats.latest_job %}
        <div class="space-y-3">
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-500">Job Name:</span>
                <span class="text-sm text-gray-900 font-mono">{{ stats.latest_job.job_name }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-500">Status:</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    {% if stats.latest_job.status == 'completed' %}bg-green-100 text-green-800
                    {% elif stats.latest_job.status == 'failed' %}bg-red-100 text-red-800
                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                    {{ stats.latest_job.status|title }}
                </span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-500">Success Rate:</span>
                <span class="text-sm text-gray-900">
                    {{ stats.latest_job.successful_spreadsheets }}/{{ stats.latest_job.total_spreadsheets }}
                    ({{ "%.1f"|format((stats.latest_job.successful_spreadsheets / stats.latest_job.total_spreadsheets * 100) if stats.latest_job.total_spreadsheets > 0 else 0) }}%)
                </span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-500">Rows Extracted:</span>
                <span class="text-sm text-gray-900">{{ stats.latest_job.total_rows }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-500">Started:</span>
                <span class="text-sm text-gray-900">{{ stats.latest_job.started_at|datetime }}</span>
            </div>
            {% if stats.latest_job.completed_at %}
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-500">Completed:</span>
                <span class="text-sm text-gray-900">{{ stats.latest_job.completed_at|datetime }}</span>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-inbox text-gray-400 text-3xl mb-3"></i>
            <p class="text-gray-500">No extraction jobs found</p>
            <p class="text-sm text-gray-400 mt-1">Run the data extractor to see job information</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Latest Updates and Recent Spreadsheets -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Latest Updates -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-clock text-survey-green mr-2"></i>
                Latest Updates
            </h3>
            <span class="text-sm text-gray-500">Last 20 changes</span>
        </div>

        {% if latest_updates %}
        <div class="space-y-4 max-h-96 overflow-y-auto">
            {% for update in latest_updates %}
            <div class="border-l-4 pl-4 py-2 hover:bg-gray-50 rounded-r-lg transition-colors
                {% if update.sheet_type == 'survey' %}border-survey-blue
                {% elif update.sheet_type == 'assessment' %}border-survey-green
                {% elif update.sheet_type == 'inventory' %}border-survey-purple
                {% else %}border-gray-300{% endif %}">

                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if update.sheet_type == 'survey' %}bg-survey-blue bg-opacity-10 text-survey-blue
                                {% elif update.sheet_type == 'assessment' %}bg-survey-green bg-opacity-10 text-survey-green
                                {% elif update.sheet_type == 'inventory' %}bg-survey-purple bg-opacity-10 text-survey-purple
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ update.sheet_type|title }}
                            </span>
                            <span class="text-xs text-gray-500">Row {{ update.row_number }}</span>
                            <span class="text-xs text-gray-500">{{ update.data_count }} fields</span>
                        </div>

                        <div class="flex items-center justify-between mb-1">
                            <p class="text-sm font-medium text-gray-900 truncate flex-1">
                                {{ update.spreadsheet_title }}
                            </p>
                            <a href="{{ update.spreadsheet_url }}" target="_blank"
                               class="ml-2 text-survey-blue hover:text-survey-blue-dark text-xs flex-shrink-0"
                               title="Open in Google Sheets">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>

                        <!-- Data Changes Preview -->
                        <div class="text-xs text-gray-600 space-y-1">
                            {% if update.key_value_pairs %}
                                <div class="bg-gray-50 rounded p-2 space-y-2">
                                    <p class="font-medium text-gray-700 mb-1">Data Added:</p>

                                    <!-- Show answers first -->
                                    {% set answers = [] %}
                                    {% set questions = [] %}
                                    {% for pair in update.key_value_pairs %}
                                        {% if pair.is_question %}
                                            {% set _ = questions.append(pair) %}
                                        {% else %}
                                            {% set _ = answers.append(pair) %}
                                        {% endif %}
                                    {% endfor %}

                                    <!-- Display answers (user responses) -->
                                    {% for pair in answers[:2] %}
                                    <div class="border-l-2 border-green-400 pl-2">
                                        <div class="flex items-start">
                                            <span class="inline-block bg-green-100 text-green-800 text-xs px-1 rounded mr-2 flex-shrink-0">Answer</span>
                                            <div class="min-w-0 flex-1">
                                                <p class="font-medium text-gray-700 text-xs">{{ pair.key|replace('_', ' ')|replace('-', ' ')|title }}</p>
                                                <p class="text-gray-800 text-xs break-words">
                                                    {% if pair.value|length > 100 %}
                                                        {{ pair.value[:97] }}...
                                                    {% else %}
                                                        {{ pair.value }}
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}

                                    <!-- Display questions (if no answers or space remaining) -->
                                    {% if answers|length == 0 %}
                                        {% for pair in questions[:2] %}
                                        <div class="border-l-2 border-blue-400 pl-2">
                                            <div class="flex items-start">
                                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-1 rounded mr-2 flex-shrink-0">Question</span>
                                                <div class="min-w-0 flex-1">
                                                    <p class="font-medium text-gray-700 text-xs">{{ pair.key|replace('_', ' ')|replace('-', ' ')|title }}</p>
                                                    <p class="text-gray-600 text-xs break-words italic">
                                                        {% if pair.value|length > 80 %}
                                                            {{ pair.value[:77] }}...
                                                        {% else %}
                                                            {{ pair.value }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}

                                    {% set total_shown = (answers[:2]|length) + (questions[:2]|length if answers|length == 0 else 0) %}
                                    {% if update.key_value_pairs|length > total_shown %}
                                    <p class="text-gray-500 italic text-xs">+ {{ update.key_value_pairs|length - total_shown }} more fields</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <p class="italic text-gray-500">No data preview available</p>
                            {% endif %}

                            <!-- Expandable Details -->
                            {% if update.key_value_pairs|length > 3 %}
                            <div class="mt-2">
                                <button onclick="toggleDetails('update-{{ update.id }}')"
                                        class="text-survey-blue hover:text-survey-blue-dark text-xs font-medium">
                                    <i class="fas fa-chevron-down mr-1" id="icon-update-{{ update.id }}"></i>
                                    View All {{ update.data_count }} Fields
                                </button>
                                <div id="details-update-{{ update.id }}" class="hidden mt-2 bg-gray-50 rounded p-2 space-y-2 max-h-40 overflow-y-auto">
                                    {% for pair in update.key_value_pairs %}
                                    <div class="border-l-2 {{ 'border-green-400' if not pair.is_question else 'border-blue-400' }} pl-2">
                                        <div class="flex items-start">
                                            <span class="inline-block {{ 'bg-green-100 text-green-800' if not pair.is_question else 'bg-blue-100 text-blue-800' }} text-xs px-1 rounded mr-2 flex-shrink-0">
                                                {{ 'Answer' if not pair.is_question else 'Question' }}
                                            </span>
                                            <div class="min-w-0 flex-1">
                                                <p class="font-medium text-gray-700 text-xs">{{ pair.key|replace('_', ' ')|replace('-', ' ')|title }}</p>
                                                <p class="text-gray-800 text-xs break-words {{ 'italic text-gray-600' if pair.is_question else '' }}">{{ pair.value }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% if update.has_more_data %}
                                    <p class="text-gray-500 italic text-xs">... and more fields</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="flex-shrink-0 ml-4">
                        <p class="text-xs text-gray-500">
                            {% if update.created_at %}
                                {{ update.created_at|datetime }}
                            {% else %}
                                Unknown time
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-clock text-gray-400 text-3xl mb-4"></i>
            <p class="text-gray-500">No recent updates</p>
            <p class="text-sm text-gray-400 mt-2">Data changes will appear here</p>
        </div>
        {% endif %}
    </div>

    <!-- Recent Spreadsheets -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-table text-survey-blue mr-2"></i>
                Recent Spreadsheets
            </h3>
            <a href="{{ url_for('spreadsheets') }}"
               class="text-survey-blue hover:text-blue-700 text-sm font-medium transition-colors">
                View All <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
    
    {% if spreadsheets %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rows</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Synced</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for sheet in spreadsheets[:5] %}
                <tr class="table-row-hover">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium
                                    {% if sheet.sheet_type == 'survey' %}bg-survey-blue
                                    {% elif sheet.sheet_type == 'assessment' %}bg-survey-green
                                    {% elif sheet.sheet_type == 'inventory' %}bg-survey-purple
                                    {% else %}bg-gray-400{% endif %}">
                                    {% if sheet.sheet_type == 'survey' %}S
                                    {% elif sheet.sheet_type == 'assessment' %}A
                                    {% elif sheet.sheet_type == 'inventory' %}I
                                    {% else %}?{% endif %}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ sheet.title }}</div>
                                <div class="text-sm text-gray-500 font-mono">{{ sheet.spreadsheet_id|truncate_id }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize
                            {% if sheet.sheet_type == 'survey' %}bg-blue-100 text-blue-800
                            {% elif sheet.sheet_type == 'assessment' %}bg-green-100 text-green-800
                            {% elif sheet.sheet_type == 'inventory' %}bg-purple-100 text-purple-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ sheet.sheet_type or 'unknown' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center">
                            <i class="fas fa-list-ol text-gray-400 mr-2"></i>
                            {{ sheet.row_count }}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sheet.last_synced|datetime }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ url_for('view_spreadsheet', spreadsheet_id=sheet.spreadsheet_id) }}" 
                           class="text-survey-blue hover:text-blue-700 transition-colors">
                            <i class="fas fa-eye mr-1"></i>View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-table text-gray-400 text-4xl mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No spreadsheets found</h3>
        <p class="text-gray-500">Run the data extractor to import Google Sheets data</p>
    </div>
    {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh dashboard every 5 minutes
    setInterval(function() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                // Update stats if needed
                console.log('Dashboard stats updated');
            })
            .catch(error => console.error('Error updating stats:', error));
    }, 300000); // 5 minutes

    // Toggle details for latest updates
    function toggleDetails(updateId) {
        const details = document.getElementById('details-' + updateId);
        const icon = document.getElementById('icon-' + updateId);

        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            details.classList.add('hidden');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
</script>
{% endblock %}
